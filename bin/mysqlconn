#!/usr/bin/env ruby

# Copyright Neville Kadwa (2014)

require 'yaml'
require 'fileutils'

CONFIG_LOCATION=File.expand_path("~/.db_connection_alias.yml")

db_key = ARGV.shift || raise('no db key provided. Usage mysqlconn db_key [mysql opts]*')

config = begin
  File.open(CONFIG_LOCATION, 'r') do |f| 
    YAML.load(f)
  end
rescue Errno::ENOENT => e
  raise("No config found. Please follow instructions for creating #{CONFIG_LOCATION}")
end
raise("Config file is world readable. Exiting...") if File.stat(CONFIG_LOCATION).world_readable?

if db_key == '-l'
  filter = /.*#{ARGV.shift||'.*'}.*/
  config.keys.each do |k|
    puts k if filter =~ k
  end 
  exit(0)
end

db = config[db_key] || raise("No #{db_key} found")

db['host'] || raise("No #{db_key}.host found")

command = "mysql -h #{db['host']} --prompt=\"\\u@#{db_key} [\\d]> \""

command << " -u #{db['user']}" if db['user']
command << " -p#{db['password']}" if db['password']
command << " -D #{db['database']}" if db['database']
unless ARGV.empty?
  command << " "
  command << ARGV.map{|s| "'#{s}'"}.join(' ')
end

exec(command)
